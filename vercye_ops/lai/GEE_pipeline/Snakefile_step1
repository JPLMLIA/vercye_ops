# type: ignore  # Prevent issues with auto-linting snakefiles

import os
from pathlib import Path

# Get list of region names from geojson files
def get_regions():
    geojsons_dir = config['geojsons_dir']
    return [Path(f).stem for f in os.listdir(geojsons_dir) if f.endswith('.geojson')]

# Define final output targets
rule all:
    input:
        expand(
            "logs/s2_export_{region_name}_{start_date}__{end_date}_done.txt",
            zip,
            region_name=[
                region
                for _ in config["timepoints"]
                for region in get_regions()
            ],
            start_date=[
                config["timepoints"][year]["start_date"]
                for year in config["timepoints"]
                for _ in get_regions()
            ],
            end_date=[
                config["timepoints"][year]["end_date"]
                for year in config["timepoints"]
                for _ in get_regions()
            ],
        )

# Rule for exporting to GDrive
rule export_s2_gdrive:
    input:
        lambda wildcards: os.path.join(config['geojsons_dir'], f"{wildcards.region_name}.geojson")
    params:
        library = config['geojsons_dir'],
        resolution = config['resolution'],
        ee_project = config['ee_project']
    output:
        "logs/s2_export_{region_name}_{start_date}__{end_date}_done.txt"
    shell:
        """
        python 1_1_gee_export_S2.py --project {params.ee_project} --library {params.library} --region {wildcards.region_name} \
        --start-date "{wildcards.start_date}" --end-date "{wildcards.end_date}" --resolution {params.resolution} \
        && touch {output}
        """
