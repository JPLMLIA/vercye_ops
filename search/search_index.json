{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"VeRCYE Documentation","text":"<p>This documentation aims to provides a comprehensive guide to running the Versatile Crop Yield Estimate (VeRCYe) pipeline. The original VeRCYe algorithm is published here.</p> <p>Currently the documentation is a work in progress, so please visit again soon.</p>"},{"location":"#features","title":"Features","text":"<ul> <li>Tools to greatly reduce manual effort required for executing the VERYCE crop yield estimate pipeline.</li> <li>All workflow steps are wrapped in a well-documented CLI interface to permit step by step execution.</li> <li>The core CLI steps are also wrapped in a Snakemake-based data processing pipeline to batch execute yield estimates in an easy to run and reproducible manner.</li> </ul>"},{"location":"Vercye/inputs/","title":"Inputs","text":"<p>To run the vercye pipeline, a number of inputs are required. In the following, we define the formats of input files and the input parameters that can be set via the snakemake config file.</p>"},{"location":"Vercye/inputs/#yield-study-setup-overview","title":"Yield Study Setup Overview","text":"<p>Your yield study is organized within a single directory referred to as the <code>simulation head directory</code>. The directory structure is outlined below:</p> <pre><code>head dir\n|   snakemake_config.yaml\n|---Year1\n|   |---TimePoint-1\n|   |   |---region1\n|   |   |   |   region1.geojson\n|   |   |   |   region1_template.apsimx\n|   |   |---region2\n|   |   |   |   region2.geojson\n|   |   |   |   region2_template.apsimx\n|   |   |---regionN\n|   |       |   regionN.geojson\n|   |       |   regionN_template.apsimx\n|   |---TimePoint-N\n|       |---region1\n|       |   |   region1.geojson\n|       |   |   region1_template.apsimx\n|       |---region2\n|       |   |   region2.geojson\n|       |   |   region2_template.apsimx\n|       |---regionN\n|           |   regionN.geojson\n|           |   regionN_template.apsimx\n|---Year2\n|   |---TimePoint-1\n|   |   |---region1\n|   |   |   |   region1.geojson\n|   |   |   |   region1_template.apsimx\n|   |   |---region2\n|   |   |   |   region2.geojson\n|   |   |   |   region2_template.apsimx\n|   |   |---regionN\n|   |       |   regionN.geojson\n|   |       |   regionN_template.apsimx\n|   |---TimePoint-N\n|       |---region1\n|       |   |   region1.geojson\n|       |   |   region1_template.apsimx\n|       |---region2\n|       |   |   region2.geojson\n|       |   |   region2_template.apsimx\n|       |---regionN\n|           |   regionN.geojson\n|           |   regionN_template.apsimx\n</code></pre> <p>The following sections describe the components of this structure, including the role of <code>snakemake_config.yaml</code>, region naming conventions, <code>GeoJSON</code> creation, timepoints, and <code>apsimx</code> templates.</p>"},{"location":"Vercye/inputs/#region-geojsons","title":"Region GeoJSONS","text":"<p>The pipeline allows execution across multiple Regions of Interest (ROIs) in a batch process. Each ROI is processed individually, and aggregated metrics across all regions are provided.</p> <p>Each ROI must be represented by an individual GeoJSON file named in the format <code>regionname.geojson</code>. For every year-timepoint combination, the directory must contain a subfolder for each region, containing its corresponding GeoJSON file. For example, if studying regions in the US, a timepoint folder may contain a folder named <code>california</code> with a file <code>california.geojson</code>.</p> <p>I only have a .shp shapefile and instead of GeoJSON - What to do? If you only have .shp shapefiles instead of GeoJSON files, use the provided helper scripts to convert them:</p> <p>Option A: Standardized, Single Administrative Level Shapefile</p> <ul> <li>Your shapefile contains geometries at a single administrative level (e.g., districts).</li> <li>It has a column named admin_name with the names of the regions.</li> <li>Use the apsim/convert_shapefile_to_geojson script to extract individual GeoJSON files.</li> </ul> <p>Option B: Mixed Administrative Levels</p> <ul> <li>Your shapefile lacks the admin_name column or contains mixed levels of geometries.</li> <li>Run the apsim/prepare_shapefile.py script to standardize the shapefile, then proceed with Option A to extract GeoJSONs.</li> </ul> <p>The documentation will soon be updated on how to process the shapefiles in more depth.</p>"},{"location":"Vercye/inputs/#years-and-timepoints","title":"Years and Timepoints","text":"<p>Years Most likely you will want to run your yield study over multiple seasons, for example to observe the change over the years. Therefore, you can definie different years in the <code>simulation head directory</code>. These should be names like the year (e.g <code>2024</code>).</p> <p>Timepoints A timepoint specifies simulation configurations within that year. For example you might want to run one simulation that considers all metereological data available one simulation that only considers metereological data up until 30 days before the latest data, to observe forecasting abilities. </p> <p>Each timepoint within a year is defined by 6 parameters: - The start date of the of the APSIM simulation - The end date of the APSIM simulation - The start date of the metereological data for that region to use - The end date of the metereological data for that region to use - The start date from when to use remotely sensed LAI data - The end date from when to use remotely sensed LAI data</p> <p>These parameters are set in in the <code>snakemake_config.yaml</code> later on and should be referred to with the name given in the <code>year folder</code> in the <code>simulation head directory</code>. So for example in the experiment described above you might want to create two timepoints called <code>T-0</code> and <code>T-30</code> as folders in each <code>year folder</code>.</p>"},{"location":"Vercye/inputs/#apsimx-templates","title":"APSIMX Templates","text":"<p>Each region in each timepoint must contain its own <code>apsimx</code> template file called <code>regionname.apsimx</code>, so for the example above <code>california_template.apsimx</code>. The <code>apsimx</code> template defines the parameters for the yield simulation of this region with <code>APSIMX</code>.</p> <p>This is the only step that requires expert knowledge to set region specific parameters for example for the soil characteristics. For every template at the different timepoints, you will have to ensure that the dates of the apsimx template file match up with the desired simulation dates specified in your snakemake config (both in <code>apsim_params</code> and <code>lai_params</code> sections). We will provide details on this in the future.</p>"},{"location":"Vercye/inputs/#snakemake-configuration-file-parameters","title":"Snakemake Configuration File Parameters","text":"<p>Now that you know about all the files and their names required to create the <code>simulation head directory</code>, we will define the <code>snakemake_config.yaml</code>. This file is the heart of the pipeline and links the <code>simulation head directory</code> with the actual definition of yield study parameters.</p> <p>Take a look at the example configuration for the format of the parameters. The following solely gives some background on the parameters.</p> <ul> <li>platform: Specify 'local' or 'umd' for dependency handling.</li> <li>sim_study_head_dir: The path to the simulation head directory.</li> <li>regions: List of regions to include (must match region folder names).</li> <li>years: List of years to include (must match year folder names).</li> <li>timepoints: List of timepoints to include (must match timepoint folder names).</li> <li>apsim_params:<ul> <li>precipitation_source: You can either use the precipitation data for the APSIM simulation from <code>NASA_POWER</code> or from <code>CHIRPS</code>. If you are using <code>CHIRPS</code>, you will have to manually download the precipitation data before starting the pipeline (<code>apsim/download_chirps_data.py</code>).</li> <li>precipitation_agg_method: When using <code>CHIRPS</code> you can aggregate the precipitation data over all CHIRPS pixels within the region as their mean, or you can use the centroid of the region. <code>NASA_POWER</code> currently only allows using the centroid.</li> <li>fallback_on_nasa_power_centroid: CHIRPS only provides coverage from -50 to 50 degrees. Therefore if the region partly falls outside of these bounds, <code>NASA_POWER</code> precipitation data can be used instead if setting to True.</li> <li>chirps_dir: The directory where the downloaded CHIRPS precipitation data is stored. Should be downloaded with <code>apsim/download_chirps_data.py</code>.</li> <li>time_bounds: Has to contain the definition of each timepoint for every year specified above. Hereby the timepoint names have to match the names specified above. For each timepoint the following parameters have to be set:<ul> <li>sim_start_date: Start date of the simulation in APSIM</li> <li>sim_end_date: End date for the simulation in APSIM</li> <li>nasa_power_start_date: Start date from when to include metereological data into APSIM.</li> <li>nasa_power_end_date: End date up to when to include meteorological data in to APSIM.</li> </ul> </li> </ul> </li> <li>lai_params:<ul> <li>lai_dir: Root directory where remotely sensed LAI data (from the LAI pipeline) is stored </li> <li>lai_region: Region name, such that the files in <code>lai_dir</code> match <code>{region}_{date}_LAI.tif</code>. Use the LAI pipeline to create such files.</li> <li>crop_name: The name of the crop for which to estimate the yield. Is related to the crop defined in APSIM. Currently \"wheat\" or \"maize\" is supprted.</li> <li>use_crop_adjusted_lai: Whether to apply the adjustment to the estimated remotely sensed estimated LAI for the crop specified above. <code>True</code> or <code>False</code>.</li> <li>lai_analysis_mode: 'raster'</li> <li>time_bounds: For every year and timepoint the start and enddate from which to use LAI data. This should usually match the simulation dates.</li> <li>crop_mask: path to the cropmasks for every year defined above.</li> </ul> </li> <li>matching_params<ul> <li>target_epsg: (To be documented).</li> </ul> </li> </ul> <p>The following will rarely have to be changed:</p> <ul> <li>apsim_execution:<ul> <li>use_docker: True or False depending on whether you want to run <code>APSIM</code> in docker or with the local executable.</li> <li>docker:<ul> <li>image: 'apsiminitiative/apsimng'</li> <li>platform: Your devices platform e.g 'linux/amd64'</li> </ul> </li> <li>local:      executable_fpath: Path to the APSIM executable on your machine     n_jobs: Number of threads to spawn. -1 is default in APSIM.</li> </ul> </li> <li>scripts: The paths to the individual scripts used in the snakemake pipeline.</li> </ul>"},{"location":"Vercye/outputs/","title":"Outputs","text":"<p>The VeRCYE pipeline produces outputs at multiple abstraction levels, such as pixel-wise yield prediction, predictions for each region of interest (ROI) and aggregated insights from multiple ROIs. In the following, we define all output artifacts and how they are computed.</p>"},{"location":"Vercye/outputs/#per-region-and-timepoint-outputs","title":"Per Region (-and timepoint) Outputs","text":"<p>Reports</p> <ul> <li>weather_report.html: Allows to interactively inspect the metereological data. All values except the rain graph are computed for the centroid of the region. For the rain graph, if the precipitation data source in the experiment is NASA_Power, this is also for the centroid. If the precipitation data source is CHIRPS, this might either be the value at the centroid or the mean of all CHIRPS values within the region, depending on what was specified in the configuration. </li> <li>yield_report.html: This summarize the yield study on this region and timepoint. The displayed values are the following:<ul> <li>Number of simulation traces in mean data: The number of APSIM simulations that best match remotely sensed LAI data, after filtering out simulations in <code>match_sim_rs_lai.py</code>. We referr to these as 'matched'</li> <li>Date range: APSIM simulation date range.</li> <li>Mean yield rate: See <code>converted_map_yield_estimate.csv</code> under <code>mean_yield_kg_ha</code>.</li> <li>Production: See <code>converted_map_yield_estimate.csv</code> under <code>total_yield_production_ton</code>.</li> <li>LAI filtered on step x: APSIM Simulated <code>Wheat.Leaf.LAI</code> (or <code>Maize.Leaf.LAI</code>) for a specific simulation and simulation date, with the simulation being filtered out at step x, as defined in <code>match_sim_rs_lai.py</code>.</li> <li>Yield filtered on step x: APSIM Simulated yield for a specific simulation and simulation date, with the simulation being filtered out at step x, as defined in <code>match_sim_rs_lai.py</code>. Yield in kg/ha.</li> <li>RS mean LAI: The remotely sensed mean LAI at each date. The mean is taken over the spatial axes, so the mean of the pixel values of all pixel locations that are within the regions geometry.</li> <li>Mean LAI: The mean simulated LAI eat each date. Hereby the mean for each date, is computed as the mean of all matched (not-filtered out) AP-SIM simulated <code>Wheat.Leaf.LAI</code> (or <code>Maize.Leaf.LAI</code>) values at that date. Yield in</li> <li>Mean Yield: Analogues to <code>Mean LAI</code> for the APSIM simulated yield. All simulated yield values are in kg/ha.</li> </ul> </li> <li>yield_report.png: A non-interactive snapshot with lower resolution of the <code>.html</code> yield report.</li> </ul> <p>Maps</p> <ul> <li>yield_map.tif: Raster output representing the yield in kg/ha per pixel. The pixel values are derived my multiplying the remotely sensed LAI with a conversion factor. The conversion factor is computed from the matched simulations of the region.</li> </ul> <p>Detailed Outputs</p> <ul> <li> <p>converted_map_yield_estimate.csv: </p> <ul> <li>mean_yield_kg_ha: Mean yield based on pixel level yield predictions from <code>yield_map.tif</code>. Mean over all pixels estimates in kg/ha.</li> <li>median_yield_kg_ha: Median yield based on pixel level yield predictions from <code>yield_map.tif</code>. Medial over all pixel estimates in kg/ha. </li> <li>total_area_ha: Total cropland in region in ha. Computed from number of cropland pixels in region multiplied with the pixel size.</li> <li>total_yield_production_kg: Total yield from the region in kg. Sum over yield per pixel.</li> <li>total_yield_production_ton: <code>total_yield_production_kg</code> / 1000</li> </ul> </li> <li> <p>sim_matches.csv: Contains aggregated statistics per APSIM simulation:</p> <ul> <li>SimulationID: The internal ID of the APSIM simulation.</li> <li>Max_Yield: The maximum yield that the APSIM simulation reaches during the specified simulation date range.</li> <li>Max_LAI: The maximum LAI that the APSIM simulation reaches during the specified simulation date range.</li> <li>StepFilteredOut: The step number at which the APSIM simulation was removed from matching candidates, as described in <code>match_sim_rs_lai.py</code>. If this field is empty/nan, the simultion was matched and not filtered out.</li> <li>Further details not publicly available at the moment.</li> </ul> </li> <li> <p>conversion_factor.csv: Contains numerous values related to the APSIM simulations (and remotely sensed LAI). <code>Max_Yield</code> and <code>Max_LAI</code> as defined in <code>sim_matches.csv</code>.</p> <ul> <li>apsim_mean_yield_estimate_kg_ha: The mean of <code>Max_Yield</code> over the remaining APSIM simulations fter filtering out simulations as described in <code>match_sim_rs_lai.py</code>.</li> <li>apsim_max_matched_lai: The maximum <code>Max_Sim_LAI</code> value over all matched (filtered) APSIM simulations. </li> <li>apsim_max_matched_lai_date: The correspinding date on which <code>apsim_max_matched_lai</code> is reached.</li> <li>apsim_max_all_lai: The maximum <code>Max_Sim_LAI</code> value over all (not-filtered) APSIM simulations. </li> <li>apsim_max_all_lai_date: The correspinding date on which <code>apsim_max_all_lai</code> is reached.</li> <li>apsim_matched_std_yield_estimate_kg_ha: The standard deviation in kg/ha of <code>Max_Yield</code> over all matched (filtered) APSIM simulations.</li> <li>apsim_all_std_yield_estimate_kg_ha: The standard deviation in kg/ha of <code>Max_Yield</code> over all (not-filtered) APSIM simulations.</li> <li>apsim_matched_maxlai_std: The standard LAI deviation of <code>Max_Sim_LAI</code> over the matched (filtered) APSIM simulations.</li> <li>apsim_all_maxlai_std: The standard LAI deviation of <code>Max_Sim_LAI</code> over all (not-filtered) APSIM simulations.</li> <li>max_rs_lai: For each date the remotely sensed mean LAI is computed (negative values clipped to 0). Hereby the mean is taken spatially over the region. <code>max_rs_lai</code> then defines the maximum LAI value of these. </li> <li>max_rs_lai_date: The correspinding date of the <code>max_rs_lai</code> value.</li> <li>conversion_factor: The factor used to convert the remotely sensed LAI raster to yield estimates that are in kg/ha per pixel.</li> </ul> </li> <li> <p>LAI_STATS.csv: Insights on the estimated LAI from the remotely sensed data.     Before computation all negative values are clipped to 0.</p> <ul> <li>Date</li> <li>n_pixels: Number of non-nan pixels in the estimated LAI raster for this date.</li> <li>interpolated: 1 if this LAI value is interpolated based on surrounding values since no remote sensed image was available on this date. 0 it is estimated with the ML model from the remotely sensed image.</li> <li>LAI mean: Mean estimated LAI value over all spatial locations at this date. </li> <li>LAI stddev: Standard deviation of LAI values over all spatial locations at this date.</li> <li>LAI mean adjusted: Mean estimated adjsuted LAI value over all spatial locations at this date. Adjustment is used to adjust for different crops e.g maize or wheat as specified in <code>3_analysis_LAI.py</code>.</li> <li>LAI stddev adjusted: Analogous to <code>LAI stddev</code> for the adjusted LAI.</li> </ul> </li> <li> <p>nasapower.csv: Meteorological data fetched from nasapower for each date in the daterange. If CHIRPS was used for precipitation data, then <code>PRECTOTCORR</code> is replaced by CHIRPS data and an additional <code>NASA_POWER_PRECTOTCORR_UNUSED</code> column is added for comparison, which is not used for the simulation. Documentation of other columns will be added soon.</p> </li> <li> <p>weather.met: Met file generated from <code>nasapower.csv*</code> for the APSIM simulations.</p> </li> <li> <p>cropmask_constrained.tif: Binary cropmask (raster) constrained to the region.</p> </li> <li>LAI_MAX.tif: Raster of the remotely sensed LAI given as the maximum value per pixel troughout the date range.</li> </ul>"},{"location":"Vercye/outputs/#aggregated-outputs","title":"Aggregated Outputs","text":"<p>The aggregated outputs are produced for each year-timepoint combination. They combine the artifacts from the indival regions into single files that are easier to work with. The filenames will contain suffixed defined as <code>yieldstudyname_totalROIname_year_timepoint</code>, to allow easier sharing of these results.</p> <ul> <li> <p>final_report_suffix.html: This document gives a final, simple to understand overview of all regional results and preview images of the maps. The description of values not listed below is either documented under the regional output section or the validation outputs section. If sharing this file, please ensure it is shared together with both following <code>.png</code> files in the same folder. </p> <ul> <li>date range: Simulation start and end date</li> <li>total yield: The sum of the estimated yield of all regions.</li> <li>weighted mean yield: The total yield divided by the total cropland area.</li> <li>total cropland area: The sum of all the area of all ROIs in ha.</li> <li>crop productivity pixel level: Visualizes the crop productivity in kg/ha per pixel. Derived from the remotely sensed LAI data coupled with the APSIM simulation trough the conversion factor.</li> </ul> </li> <li> <p>yield_map_suffix.png: Preview image of all ROI boundaries with the corresponding mean and median yield in kg/ha.</p> </li> <li> <p>aggregated_yield_map_preview_suffix.png: Downsampled image preview of the all regional pixel-level yieldmaps merged into one.</p> </li> <li> <p>aggregated_yield_map_suffix.tif: Spatially aggregated yield maps from all regions (See regional <code>yield_map.tif</code>).</p> </li> <li>aggregated_LAI_max_suffix.tif: Spatially aggregated LAI_MAX maps from all regions (See regional <code>LAI_MAX.tif</code>).</li> <li>aggregated_cropmask_suffix.tif: Spatially aggregated cropmasks from all regions (See regional <code>cropmask_constrained.tif</code>). </li> <li>aggregated_region_boundaries_suffix.geojson: All regional geojsons merged into a single one for easier importing into GIS.</li> </ul>"},{"location":"Vercye/outputs/#validation-outputs","title":"Validation Outputs","text":"<p>If reported (ground truth) data was provided, common metrics are written to the <code>final_report.html</code>.</p> <ul> <li>mean_err_kg_ha: The mean error computed as the mean over the yield errors (predicted_mean_yield - reported__mean_yield) of all study regions. Hereby the predicted and reported yield are the mean yield of the region in kg/ha.</li> <li>median_err_kg_ha: The median error computed as the median over the yield errors (predicted_mean_yield - reported__mean_yield) of all study regions. Hereby the predicted and reported yield are the mean yield of the region in kg/ha.</li> <li>rmse: The root mean square error of the predicted and reported mean yields of all study regions in kg/ha.</li> <li>rrmse: rmse / mean(reported_mean_yield)</li> <li>r2: The R2 score of the predicted and reported mean yield per region.</li> </ul>"}]}